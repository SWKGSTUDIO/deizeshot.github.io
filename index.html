<!DOCTYPE html>
<html lang="en" style="width: 100%;height: 100%;background: url(&quot;assets/img/background.webp&quot;) center / cover repeat, rgba(0,0,0,0);margin: 0;padding: 0;">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <title>SWKG</title>
    <link rel="stylesheet" href="assets/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="assets/fonts/fontawesome-all.min.css">
    <link rel="stylesheet" href="assets/css/Background.css">
    <link rel="stylesheet" href="assets/css/chat.css">
    <link rel="stylesheet" href="assets/css/styles.css">
    <link rel="stylesheet" href="assets/css/tileback.css">
</head>

<body style="background: rgba(255,255,255,0);height: 100%;width: 100%;"><img style="width: 100%;height: 100%;background: url(&quot;assets/img/tile.png&quot;) center / auto repeat;position: absolute;overflow: hidden;opacity: 0.09;text-align: left;z-index: -1;animation: slideAnima 190000s linear infinite;">
    <div class="container" style="width: 100%;position: relative;"><img src="assets/img/logo.webp" width="69" height="110" style="padding-right: 0;padding-bottom: 0;padding-left: 0;padding-top: 0;margin-top: 20px;margin-bottom: 30px;"></div>
    <div class="container">
        <div class="row">
            <div class="col-md-6">
                <div class="row" style="text-align: center;"><div class="col-md-12"></div>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
                  <div id="list-widget" style="display: none;"></div>
<script>
  const apiKey = 'key9kpLHqsdRFXvS2';
  const baseId = 'appaePimTt1Ji6hSr';
  const tableName = 'tblivWUpxtGbTszm3';

  fetch(`https://api.airtable.com/v0/${baseId}/${tableName}?api_key=${apiKey}`)
    .then(response => response.json())
    .then(data => {
      const listWidget = document.getElementById('list-widget');
      const ul = document.createElement('ul');
      ul.classList.add('button-list', 'horizontal');

      // Сортировка данных по полю "Num"
      data.records.sort((a, b) => a.fields.Num - b.fields.Num);

      data.records.forEach(record => {
        const fields = record.fields;
        const name = fields.Name;
        const imageUrl = fields.Image;
        const url = fields.URL;
        const power = fields.Power;

        const button = document.createElement('button');
        const img = document.createElement('img');
        img.src = imageUrl;
        img.alt = name;
        button.appendChild(img);

        const span = document.createElement('span');
        span.innerText = name;
        span.classList.add('image-text');
        img.parentNode.insertBefore(span, img.nextSibling);

        const li = document.createElement('li');

        // Проверка значения поля "Power" и установка классов CSS
        if (power === "ON") {
          button.classList.add('button-on');
          button.addEventListener('click', () => {
            window.location.href = url;
          });
        } else if (power === "OFF") {
          button.classList.add('button-off');
          button.disabled = true;
        }

        li.classList.add('hide');
        li.appendChild(button);
        ul.appendChild(li);
      });

      listWidget.appendChild(ul);

      setTimeout(function() {
        document.getElementById('list-widget').style.display = 'block';

        const listItems = ul.querySelectorAll('li');
        listItems.forEach((item, index) => {
          setTimeout(function() {
            item.classList.add('show');
          }, index * 50);
        });
      }, 100);
    })
    .catch(error => {
      console.error(error);
    });
</script>
</div>
            </div>
            <div class="col-md-6">
                <div class="row" style="text-align: right;">
                    <div class="col"><span style="color: rgb(255,255,255);">Чат /bot</span><div class="chat-container">
                <div class="chat-messages" id="chatMessages">
                    <div class="chat-message sent">
                      
                  </div>
                  
                  <div class="chat-message received">
                    
                </div>
                </div>
                <div class="chat-input">
                    <input type="text" id="messageInput" placeholder="Cообщение...">
                    <button id="sendButton">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
<script>
const ws = new WebSocket('wss://intermediate-easy-ship.glitch.me');

ws.onopen = () => {
  console.log('Connected to the WebSocket server.');
};

ws.onmessage = (event) => {
  const data = JSON.parse(event.data);

  if (data.type === 'chat-history') {
    const history = data.messages;
    // Очищаем текущий чат перед отображением истории сообщений
    document.getElementById('chatMessages').innerHTML = '';
    history.forEach(message => displayMessage(message));
  } else if (data.type === 'chat-message') {
    const message = data.message;
    displayMessage(message);
  }
};

function displayMessage(message) {
  const chatMessages = document.getElementById('chatMessages');
  const messageDiv = document.createElement('div');
  messageDiv.classList.add('chat-message');

  // Добавляем текст сообщения с пробелом и временем
  const messageTextWithTime = document.createElement('div');
  messageTextWithTime.textContent = message.text + ' ' + message.time;
  messageDiv.appendChild(messageTextWithTime);

  // Добавляем класс в зависимости от типа сообщения (отправленное или полученное)
  if (message.type === 'chat') {
    messageDiv.classList.add('sent'); // Здесь можно использовать класс 'received' для полученных сообщений
  }

  chatMessages.appendChild(messageDiv);
  chatMessages.scrollTop = chatMessages.scrollHeight;
}

// Функция для получения текущего времени в формате "HH:mm"
function getTimeString() {
  const now = new Date();
  const hours = String(now.getHours()).padStart(2, '0');
  const minutes = String(now.getMinutes()).padStart(2, '0');
  return `${hours}:${minutes}`;
}

function sendMessage() {
  const messageInput = document.getElementById('messageInput');
  let messageText = messageInput.value.trim();

  if (messageText !== '') {
    // Проверяем, содержит ли сообщение текст вида "/bot @username" и извлекаем @имя пользователя
    const usernameMatch = messageText.match(/@(\w+)/);
    if (usernameMatch) {
      const username = usernameMatch[1];
      messageText = messageText.replace(/@(\w+)/, ''); // Удаляем из сообщения текст с @именем пользователя
      sendMessageToServer({ type: 'chat', text: messageText, username: username });
    } else {
      sendMessageToServer({ type: 'chat', text: messageText });
    }

    messageInput.value = '';
  }
}

async function sendMessageToServer(message) {
  const currentTime = getTimeString(); // Получаем текущее время в формате "HH:mm"
  message.time = currentTime; // Добавляем поле "time" с текущим временем в объект сообщения

  ws.send(JSON.stringify(message));
}

// Обработчик события нажатия клавиши Enter
document.getElementById('messageInput').addEventListener('keydown', (event) => {
  if (event.key === 'Enter') {
    sendMessage();
  }
});

// Пример отправки сообщения на сервер при клике на кнопку "Отправить"
document.getElementById('sendButton').addEventListener('click', sendMessage);
</script></div>
                </div>
            </div>
        </div>
    </div>
    <script src="assets/bootstrap/js/bootstrap.min.js"></script>
</body>

</html>